<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>Generate Shell Configuration from TOML</title>
    <status>drafted</status>
    <generatedAt>2025-10-31</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>/Users/anna/code/annabarnes1138/zprof/docs/stories/2-2-generate-shell-configuration-from-yaml.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>zprof to automatically generate .zshrc and .zshenv from my TOML manifest</iWant>
    <soThat>my declarative configuration is translated into functional shell files</soThat>
    <tasks>
      <task id="1" ac="All">Create shell generator module (shell/generator.rs with generation functions for .zshrc and .zshenv)</task>
      <task id="2" ac="2,3,5">Implement .zshenv generation with header comments, shared history config, and env var exports with proper escaping</task>
      <task id="3" ac="1,3,5">Implement .zshrc generation for each framework (oh-my-zsh, zimfw, prezto, zinit, zap) with framework-specific patterns</task>
      <task id="4" ac="4,6">Implement file writing operations that overwrite existing files and complete in under 1 second</task>
      <task id="5" ac="4">Add regeneration command (RegenerateArgs with profile_name loading manifest and calling write_generated_files)</task>
      <task id="6" ac="All">Handle edge cases and errors (missing directories, invalid manifests, unsupported frameworks, permission errors, syntax validation)</task>
      <task id="7" ac="All">Write comprehensive tests (unit tests for generation, integration tests for file writing, manual tests for all frameworks)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">System generates .zshrc with framework initialization, plugin loading, and theme activation</criterion>
    <criterion id="2">System generates .zshenv with environment variables from manifest</criterion>
    <criterion id="3">Generated files include header comments indicating they're auto-generated from manifest</criterion>
    <criterion id="4">Re-generation from manifest overwrites previous generated files (manifest is source of truth)</criterion>
    <criterion id="5">Generated configuration is syntactically valid zsh code</criterion>
    <criterion id="6">Process completes in under 1 second for typical profiles</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>FR013 - Generate Shell Configuration from TOML</section>
        <snippet>System shall generate functional .zshrc and .zshenv files from TOML manifest specifications</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>NFR001 - Performance</section>
        <snippet>Profile switching shall complete in under 500ms. Story 2.2 subset: generation must complete in under 1 second</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>ADR-002 - TOML as Configuration Format</section>
        <snippet>TOML chosen over YAML for no indentation sensitivity, explicit typing, Rust/Go developer familiarity. Manifest is source of truth for all configuration</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Pattern 5 - Shell Integration</section>
        <snippet>Module: shell/generator.rs generates .zshrc/.zshenv from manifest. Framework-specific generation patterns for oh-my-zsh, zimfw, prezto, zinit, zap</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Pattern 2 - Error Handling</section>
        <snippet>Use anyhow::Context for all errors. Rich error context with helpful messages for users</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Epic 2 Story 2.2 Mapping</section>
        <snippet>Primary modules: shell/generator.rs. Secondary modules: core/manifest.rs</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 2 - TOML Manifests & Export/Import</section>
        <snippet>Story 2.2 builds on Story 2.1 manifest parsing to generate functional shell files. Manifest is source of truth - regeneration overwrites previous files</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-1-parse-and-validate-yaml-manifests.md</path>
        <title>Story 2.1 - Parse and Validate TOML Manifests</title>
        <section>Manifest Structure</section>
        <snippet>ProfileManifest contains profile.name, profile.framework, profile.theme, plugins.enabled (array), env (key-value map). Use load_and_validate() to get validated manifest</snippet>
      </doc>
    </docs>
    <code>
      <!-- No existing code - greenfield implementation -->
      <note>This is the first story being implemented. No existing codebase to reference. Follow architecture patterns from docs/architecture.md</note>
    </code>
    <dependencies>
      <rust>
        <crate name="anyhow" version="2.0" purpose="Error handling with context"/>
        <crate name="serde" version="1.0" purpose="Serialize/deserialize for TOML structures"/>
        <crate name="toml" version="0.9" purpose="Parse TOML manifests"/>
        <crate name="chrono" version="latest" purpose="ISO 8601 timestamps for generated file headers"/>
        <crate name="log" version="latest" purpose="Logging for debugging"/>
        <crate name="dirs" version="latest" purpose="Locate home directory for profile paths"/>
      </rust>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="module_structure">Primary module: shell/generator.rs. Secondary: core/manifest.rs (reads manifest), cli/regenerate.rs (CLI command)</constraint>
    <constraint type="architecture_pattern">Follow Pattern 5 (Shell Integration) from architecture.md</constraint>
    <constraint type="error_handling">Follow Pattern 2 (Error Handling): Use anyhow::Context for all errors with helpful user messages</constraint>
    <constraint type="adr">Implements ADR-002: TOML as source of truth. Regeneration overwrites previous files without merge</constraint>
    <constraint type="performance">Must complete in under 1 second for typical profiles (NFR001 subset)</constraint>
    <constraint type="frameworks">Support exactly 5 frameworks: oh-my-zsh, zimfw, prezto, zinit, zap. Framework-specific generation templates required</constraint>
    <constraint type="file_output">Generated files must include warning headers: "Auto-generated from profile.toml - DO NOT EDIT"</constraint>
    <constraint type="shared_history">Generated .zshenv must set HISTFILE to ~/.zsh-profiles/shared/.zsh_history for cross-profile history</constraint>
    <constraint type="syntax_validation">Generated .zshrc files must be syntactically valid zsh code (validate with zsh -n)</constraint>
    <constraint type="env_escaping">Environment variable values must have special shell characters escaped (quotes, backslashes, dollar signs, backticks)</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>generate_zshenv</name>
      <kind>function</kind>
      <signature>pub fn generate_zshenv(manifest: &ProfileManifest) -> Result&lt;String&gt;</signature>
      <path>src/shell/generator.rs</path>
      <description>Generates .zshenv content with header, shared history config, and environment variables from manifest</description>
    </interface>
    <interface>
      <name>generate_zshrc</name>
      <kind>function</kind>
      <signature>pub fn generate_zshrc(manifest: &ProfileManifest) -> Result&lt;String&gt;</signature>
      <path>src/shell/generator.rs</path>
      <description>Generates framework-specific .zshrc content by dispatching to framework-specific functions</description>
    </interface>
    <interface>
      <name>write_generated_files</name>
      <kind>function</kind>
      <signature>pub fn write_generated_files(profile_name: &str, manifest: &ProfileManifest) -> Result&lt;()&gt;</signature>
      <path>src/shell/generator.rs</path>
      <description>Orchestrates generation and writing of .zshrc and .zshenv files to profile directory. Validates syntax and checks performance</description>
    </interface>
    <interface>
      <name>ProfileManifest (from Story 2.1)</name>
      <kind>struct</kind>
      <signature>Deserializable TOML structure with profile.name, profile.framework, profile.theme, plugins.enabled, env fields</signature>
      <path>src/core/manifest.rs</path>
      <description>Input structure for generation. Loaded and validated by Story 2.1's load_and_validate() function</description>
    </interface>
  </interfaces>
  <tests>
    <standards>Use Rust's built-in testing framework (#[test] and #[cfg(test)]) for unit tests. Use insta for snapshot testing of generated shell files. Integration tests go in tests/ directory. Manual testing required for actual zsh execution with real framework installations</standards>
    <locations>
      <location>src/shell/generator.rs - Unit tests in same file under #[cfg(test)] module</location>
      <location>tests/generator_test.rs - Integration tests for full generation workflow</location>
      <location>tests/snapshots/ - Insta snapshot files for generated output validation</location>
    </locations>
    <ideas>
      <test_idea ac="2,3,5">Unit test generate_zshenv() with various env vars, verify header comments, shared history config, and proper escaping of special characters</test_idea>
      <test_idea ac="1,3,5">Unit test generate_zshrc() for each of the 5 frameworks (oh-my-zsh, zimfw, prezto, zinit, zap) to ensure correct framework-specific syntax</test_idea>
      <test_idea ac="5">Unit test escape_shell_value() with quotes, backslashes, dollar signs, and backticks to ensure proper escaping</test_idea>
      <test_idea ac="4,6">Integration test write_generated_files() that creates temp profile directory, generates files, verifies overwrite behavior, and checks sub-1-second performance</test_idea>
      <test_idea ac="5">Integration test validate_zsh_syntax() by generating files and running 'zsh -n' to verify syntactic validity</test_idea>
      <test_idea ac="All">Snapshot test with insta to capture expected output format for all frameworks and verify consistency across regenerations</test_idea>
      <test_idea ac="1,5">Manual test: Install actual oh-my-zsh, generate profile, source .zshrc in real zsh, verify plugins load without errors</test_idea>
      <test_idea ac="1,5">Manual test: Repeat for all 5 frameworks (zimfw, prezto, zinit, zap) with real framework installations</test_idea>
    </ideas>
  </tests>
</story-context>
