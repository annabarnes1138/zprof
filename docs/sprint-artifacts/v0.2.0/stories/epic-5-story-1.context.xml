<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>1</storyId>
    <title>Add Deprecation Warning to Rollback Command</title>
    <status>drafted</status>
    <generatedAt>2025-11-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/v0.2.0/stories/epic-5-story-1.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user running zprof rollback</asA>
    <iWant>a clear message directing me to the new command</iWant>
    <soThat>know what to use instead</soThat>
    <tasks>
      - Show deprecation warning with details
      - Default to No (must confirm)
      - Add --force flag to skip warning
      - Add to CLI help: "(deprecated)"
      - Log deprecation
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">Show deprecation warning with details</criterion>
    <criterion id="AC2">Default to No (must confirm)</criterion>
    <criterion id="AC3">Add --force flag to skip warning</criterion>
    <criterion id="AC4">Add to CLI help: "(deprecated)"</criterion>
    <criterion id="AC5">Log deprecation</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-5.md</path>
        <title>Epic Technical Specification: Remove Deprecated Rollback Command</title>
        <section>Overview</section>
        <snippet>This epic focuses on the deprecation and eventual removal of the `zprof rollback` command, which has been superseded by the more comprehensive `zprof uninstall` command introduced in Epic 3.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-5.md</path>
        <title>Epic Technical Specification: Remove Deprecated Rollback Command</title>
        <section>Deprecation Warning Message Contract</section>
        <snippet>Warning: 'zprof rollback' is deprecated and will be removed in v0.3.0. Use 'zprof uninstall' instead, which provides more options: restore, promote, clean removal.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-5.md</path>
        <title>Epic Technical Specification: Remove Deprecated Rollback Command</title>
        <section>APIs and Interfaces</section>
        <snippet>Modified CLI Command Interface with --force flag to skip deprecation warning. Response codes: Exit 0 for success/cancelled, Exit 1 for failure.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-5.md</path>
        <title>Epic Technical Specification: Remove Deprecated Rollback Command</title>
        <section>Workflows and Sequencing - Workflow 1</section>
        <snippet>User runs `zprof rollback` (interactive) → Check args.force flag → Show deprecation warning → Confirm continuation → Execute or cancel based on user input.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/cli/rollback.rs</path>
        <kind>cli command module</kind>
        <symbol>RollbackArgs</symbol>
        <lines>10-19</lines>
        <reason>Existing argument struct that needs --force flag added for deprecation bypass</reason>
      </artifact>
      <artifact>
        <path>src/cli/rollback.rs</path>
        <kind>cli command module</kind>
        <symbol>execute</symbol>
        <lines>35-57</lines>
        <reason>Main execute function where deprecation warning flow needs to be added before existing logic</reason>
      </artifact>
      <artifact>
        <path>src/cli/rollback.rs</path>
        <kind>cli command module</kind>
        <symbol>confirm_rollback</symbol>
        <lines>295-304</lines>
        <reason>Existing confirmation pattern that can be used as reference for deprecation confirmation</reason>
      </artifact>
      <artifact>
        <path>src/cli/mod.rs</path>
        <kind>cli module registry</kind>
        <symbol>N/A</symbol>
        <lines>1-17</lines>
        <reason>Module registry where rollback is exported; needs to be aware of deprecation status</reason>
      </artifact>
      <artifact>
        <path>tests/rollback_test.rs</path>
        <kind>integration test</kind>
        <symbol>N/A</symbol>
        <lines>all</lines>
        <reason>Existing rollback tests that must continue passing to ensure backward compatibility</reason>
      </artifact>
    </code>
    <dependencies>
      <rust>
        <dependency name="clap" version="4.5.51" features="derive">CLI argument parsing - already supports adding new flags to existing commands</dependency>
        <dependency name="dialoguer" version="0.11">Interactive prompts - provides Confirm widget for y/n prompts</dependency>
        <dependency name="anyhow" version="1.0">Error handling - existing pattern for error messages</dependency>
        <dependency name="log" version="0.4">Logging - needed for logging deprecation events at INFO level</dependency>
      </rust>
      <dev>
        <dependency name="insta" version="1.34">Snapshot testing - useful for help text validation</dependency>
        <dependency name="tempfile" version="3.8">Test isolation - already used in rollback tests</dependency>
        <dependency name="serial_test" version="3.0">Test serialization - already used for HOME modification tests</dependency>
      </dev>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Must maintain 100% backward compatibility - command must still work when user confirms</constraint>
    <constraint>Follow existing anyhow error handling patterns in codebase</constraint>
    <constraint>Use clap derive macros for argument parsing consistency</constraint>
    <constraint>Preserve existing test coverage - all rollback tests must continue passing</constraint>
    <constraint>Interactive prompts must work in both interactive and non-interactive terminals</constraint>
    <constraint>Exit code 0 for cancellation (not an error), exit code 1 for failures</constraint>
    <constraint>Use Unix permissions mode 0o644 for restored files (existing pattern)</constraint>
    <constraint>Code must be marked with TODO(v0.3.0) comments for future removal</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>RollbackArgs</name>
      <kind>struct</kind>
      <signature>
#[derive(Debug, Args)]
pub struct RollbackArgs {
    #[arg(long, default_value = "false")]
    pub force: bool,
    // Existing fields...
}
      </signature>
      <path>src/cli/rollback.rs</path>
    </interface>
    <interface>
      <name>show_deprecation_warning</name>
      <kind>function (new)</kind>
      <signature>fn show_deprecation_warning() -> Result&lt;()&gt;</signature>
      <path>src/cli/rollback.rs</path>
    </interface>
    <interface>
      <name>confirm_continue</name>
      <kind>function (new)</kind>
      <signature>fn confirm_continue() -> Result&lt;bool&gt;</signature>
      <path>src/cli/rollback.rs</path>
    </interface>
    <interface>
      <name>execute</name>
      <kind>function (modified)</kind>
      <signature>pub fn execute(args: RollbackArgs) -> Result&lt;()&gt;</signature>
      <path>src/cli/rollback.rs</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use Rust's built-in test framework with #[test] attribute. Integration tests in tests/ directory use tempfile for isolation and serial_test for HOME modifications. Snapshot testing with insta crate for help text and warning message validation. Follow existing patterns from tests/rollback_test.rs.
    </standards>
    <locations>
      - tests/rollback_deprecation_test.rs (new file for deprecation-specific tests)
      - tests/rollback_test.rs (existing tests must continue passing)
      - src/cli/rollback.rs (inline unit tests at bottom of file)
    </locations>
    <ideas>
      <test criterion="AC1" idea="Snapshot test for deprecation warning message format and content"/>
      <test criterion="AC2" idea="Test that default behavior (no input) cancels rollback without error"/>
      <test criterion="AC2" idea="Test that 'n' or 'N' input cancels rollback gracefully"/>
      <test criterion="AC2" idea="Test that 'y' or 'Y' input proceeds with rollback execution"/>
      <test criterion="AC3" idea="Test that --force flag completely bypasses warning and confirmation"/>
      <test criterion="AC3" idea="Test that --force executes rollback immediately without prompts"/>
      <test criterion="AC4" idea="Snapshot test for 'zprof --help' showing '(deprecated)' marker"/>
      <test criterion="AC4" idea="Snapshot test for 'zprof rollback --help' showing migration guidance"/>
      <test criterion="AC5" idea="Verify log messages are emitted at INFO level for deprecation events"/>
      <test criterion="all" idea="Test non-interactive terminal handling - should error with clear message about --force"/>
      <test criterion="all" idea="Backward compatibility test - existing rollback functionality unchanged when confirmed"/>
    </ideas>
  </tests>
</story-context>
